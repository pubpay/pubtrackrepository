<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>META ADS - Dashboard LeadRock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .slide-down {
            animation: slideDown 0.3s ease-out;
        }
        .pulse-green {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .calendar-day {
            transition: all 0.2s;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-day:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        .calendar-day.has-conversions {
            background-color: #dbeafe;
            font-weight: 600;
        }
        .calendar-day.has-conversions:hover {
            background-color: #bfdbfe;
        }
        .calendar-day.selected {
            background-color: #3b82f6;
            color: white;
            font-weight: 700;
        }
        .calendar-day.selected:hover {
            background-color: #2563eb;
        }
        .calendar-day.today {
            border: 2px solid #3b82f6;
        }
        .tab-button {
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        .hierarchy-item {
            transition: all 0.2s;
        }
        .hierarchy-item:hover {
            background-color: #f3f4f6;
        }
        .hierarchy-item.selected {
            background-color: #dbeafe;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Container principal -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-red-600 mb-2">üìä META ADS</h1>
                    <p class="text-gray-600">Monitoramento de campanhas Meta Ads</p>
                </div>
                <div class="flex gap-2">
                    <button id="btnUploadXLSX" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Upload Campanhas XLSX
                    </button>
                    <a href="index.html" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        Voltar ao Dashboard
                    </a>
                    <button id="btnCadastroProdutos" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Cadastro de Produtos
                    </button>
                    <button id="btnProdutos" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        Produtos
                    </button>
                    <button id="btnContas" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        Contas
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Upload XLSX -->
        <div id="modalUploadXLSX" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Upload Campanhas Facebook (XLSX)</h3>
                        <button id="closeUploadXLSX" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <input type="file" id="fileInputXLSX" accept=".xlsx,.xls" class="hidden">
                        <label for="fileInputXLSX" class="cursor-pointer inline-block px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                            Selecionar Arquivo XLSX
                        </label>
                        <span id="fileName" class="ml-4 text-gray-600"></span>
                    </div>
                    
                    <div id="xlsxResults" class="hidden">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Campanhas Encontradas (Gastos)</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Campanha</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gastos (BRL)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="xlsxTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                        <div id="xlsxSummary" class="mt-4 p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600"><span id="totalCampanhas">0</span> campanhas encontradas no app</p>
                            <p class="text-sm text-gray-600">Total de gastos: <span id="totalGastos" class="font-semibold">R$ 0,00</span></p>
                        </div>
                    </div>
                    
                    <div id="xlsxError" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Cadastro de Produtos -->
        <div id="modalCadastroProdutos" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Cadastro de Produtos</h3>
                        <button id="closeCadastroProdutos" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Formul√°rio de Cadastro -->
                    <form id="formProduto" class="mb-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Produto *</label>
                                <input type="text" id="nomeProduto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Offer ID do Produto *</label>
                                <input type="text" id="offerIdProduto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Conta *</label>
                                <input type="text" id="nomeContaProduto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nome personalizado para a categoria">
                            </div>
                            <button type="submit" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                Cadastrar Produto
                            </button>
                        </div>
                    </form>
                    
                    <!-- Lista de Produtos Cadastrados -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Produtos Cadastrados</h4>
                        <div id="listaProdutos" class="space-y-2">
                            <div class="text-center text-gray-500 py-4">Carregando produtos...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Visualiza√ß√£o de Produtos -->
        <div id="modalProdutos" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Selecionar Produto</h3>
                        <button id="closeProdutos" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div id="listaProdutosSelecao" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="text-center text-gray-500 py-8">Carregando produtos...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Visualiza√ß√£o de Contas -->
        <div id="modalContas" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Selecionar Conta do Facebook</h3>
                        <button id="closeContas" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div id="listaContasSelecao" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="text-center text-gray-500 py-8">Carregando contas...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros Ativos -->
        <div class="flex flex-col gap-4 mb-6">
            <!-- Filtro de Produto Ativo -->
            <div id="filtroProdutoAtivo" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                        </svg>
                        <div>
                            <div class="font-semibold text-blue-900">Filtro de Produto: <span id="nomeProdutoFiltro"></span></div>
                            <div class="text-sm text-blue-700">Offer ID: <span id="offerIdFiltro"></span></div>
                        </div>
                    </div>
                    <button id="removerFiltroProduto" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm transition-colors">
                        Remover Filtro
                    </button>
                </div>
            </div>

            <!-- Filtro de Conta Ativo -->
            <div id="filtroContaAtivo" class="hidden bg-orange-50 border border-orange-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <div>
                            <div class="font-semibold text-orange-900">Filtro de Conta: <span id="nomeContaFiltro"></span></div>
                        </div>
                    </div>
                    <button id="removerFiltroConta" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm transition-colors">
                        Remover Filtro
                    </button>
                </div>
            </div>
        </div>

        <!-- Alerta de novo postback -->
        <div id="alert" class="hidden mb-6 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg slide-down">
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="font-semibold">Novo postback recebido!</span>
            </div>
        </div>

        <!-- Filtros de Data -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
                <!-- Bot√£o de Sele√ß√£o de Data -->
                <div class="flex items-center gap-2">
                    <button id="datePickerBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg border border-gray-300 flex items-center gap-2 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span id="datePickerText">Hoje: <span id="currentDateDisplay"></span></span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <button id="resetFilter" class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm">
                        Ver Todas
                    </button>
                </div>

                <!-- Informa√ß√µes do Per√≠odo Selecionado -->
                <div class="flex-1 flex items-center gap-4 text-sm">
                    <div id="selectedPeriodInfo" class="text-gray-600">
                        <span id="selectedPeriodText">Mostrando todas as convers√µes</span>
                    </div>
                </div>
            </div>

            <!-- Date Picker Modal (oculto por padr√£o) -->
            <div id="datePickerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Selecionar Per√≠odo</h3>
                            <button id="closeDatePicker" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <div class="flex flex-col md:flex-row gap-6">
                            <!-- Op√ß√µes R√°pidas -->
                            <div class="md:w-64 border-r border-gray-200 pr-6">
                                <h4 class="font-semibold text-gray-700 mb-3 text-sm">Usados recentemente</h4>
                                <div class="space-y-1 max-h-96 overflow-y-auto">
                                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                                        <input type="radio" name="quickDate" value="today" class="mr-2">
                                        <span class="text-sm">Hoje</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                                        <input type="radio" name="quickDate" value="yesterday" class="mr-2">
                                        <span class="text-sm">Ontem</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                                        <input type="radio" name="quickDate" value="last7days" class="mr-2">
                                        <span class="text-sm">√öltimos 7 dias</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                                        <input type="radio" name="quickDate" value="last14days" class="mr-2">
                                        <span class="text-sm">√öltimos 14 dias</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                                        <input type="radio" name="quickDate" value="last30days" class="mr-2">
                                        <span class="text-sm">√öltimos 30 dias</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                                        <input type="radio" name="quickDate" value="thisWeek" class="mr-2">
                                        <span class="text-sm">Esta semana</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                                        <input type="radio" name="quickDate" value="lastWeek" class="mr-2">
                                        <span class="text-sm">Semana passada</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                                        <input type="radio" name="quickDate" value="thisMonth" class="mr-2">
                                        <span class="text-sm">Este m√™s</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                                        <input type="radio" name="quickDate" value="lastMonth" class="mr-2">
                                        <span class="text-sm">M√™s passado</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Calend√°rio Compacto -->
                            <div class="flex-1">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Selecionar intervalo de datas</label>
                                    <div class="flex items-center gap-2">
                                        <input type="date" id="startDate" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <span class="text-gray-500">at√©</span>
                                        <input type="date" id="endDate" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    </div>
                                </div>

                                <!-- Calend√°rio Visual Compacto -->
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <button id="prevMonth" class="p-1 hover:bg-gray-100 rounded">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                            </svg>
                                        </button>
                                        <h3 id="currentMonth" class="text-sm font-semibold text-gray-700"></h3>
                                        <button id="nextMonth" class="p-1 hover:bg-gray-100 rounded">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div id="calendar" class="grid grid-cols-7 gap-1 text-xs">
                                        <!-- Dias da semana -->
                                        <div class="text-center font-semibold text-gray-600 py-1 text-xs">D</div>
                                        <div class="text-center font-semibold text-gray-600 py-1 text-xs">S</div>
                                        <div class="text-center font-semibold text-gray-600 py-1 text-xs">T</div>
                                        <div class="text-center font-semibold text-gray-600 py-1 text-xs">Q</div>
                                        <div class="text-center font-semibold text-gray-600 py-1 text-xs">Q</div>
                                        <div class="text-center font-semibold text-gray-600 py-1 text-xs">S</div>
                                        <div class="text-center font-semibold text-gray-600 py-1 text-xs">S</div>
                                    </div>
                                </div>

                                <!-- Bot√µes de A√ß√£o -->
                                <div class="flex justify-end gap-2 mt-4">
                                    <button id="cancelDatePicker" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                                        Cancelar
                                    </button>
                                    <button id="applyDatePicker" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                        Atualizar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- M√©tricas Financeiras -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">üí∏ Total de Gasto da Conta</div>
                <div class="text-3xl font-bold text-red-600" id="totalGastosConta">R$ 0,00</div>
                <div class="text-xs text-gray-500 mt-1">Soma de todos os gastos do XLSX</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">üí∞ Valor Total de Vendas</div>
                <div class="text-3xl font-bold text-green-600" id="totalVendasBRL">R$ 0,00</div>
                <div class="text-xs text-gray-500 mt-1" id="totalVendasUSD">$ 0,00 USD</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">üìà ROAS</div>
                <div class="text-3xl font-bold" id="roasConta">0,00x</div>
                <div class="text-xs text-gray-500 mt-1">Retorno sobre investimento</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">üìä Taxa de Aprova√ß√£o</div>
                <div class="text-3xl font-bold text-emerald-600" id="taxaAprovacao">0.00%</div>
                <div class="text-xs text-gray-500 mt-1">Leads Aprovados / Leads Totais</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">üíµ Lucro</div>
                <div class="text-3xl font-bold" id="lucroConta">R$ 0,00</div>
                <div class="text-xs text-gray-500 mt-1">Vendas - Gastos</div>
            </div>
        </div>

        <!-- Estat√≠sticas -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">üìä Total de Leads</div>
                <div class="text-3xl font-bold text-blue-600" id="totalLeads">0</div>
                <div class="text-xs text-gray-500 mt-1">Todos os leads</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">‚úÖ Leads Confirmados</div>
                <div class="text-3xl font-bold text-green-600" id="leadsConfirmados">0</div>
                <div class="text-xs text-gray-500 mt-1">Convers√µes aprovadas</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">‚ùå Leads Cancelados</div>
                <div class="text-3xl font-bold text-red-600" id="leadsCancelados">0</div>
                <div class="text-xs text-gray-500 mt-1">Rejeitados</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-gray-600 text-sm font-medium mb-1">üóëÔ∏è Leads Trash</div>
                <div class="text-3xl font-bold text-orange-600" id="leadsTrash">0</div>
                <div class="text-xs text-gray-500 mt-1">Marcados como lixo</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 relative">
                <!-- Campo de Taxa de C√¢mbio -->
                <div class="absolute -top-3 left-4 bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-semibold">
                    TAXA DE C√ÇMBIO
                </div>
                <div class="mb-3 pt-2">
                    <label class="block text-xs text-gray-600 mb-1">Taxa USD ‚Üí BRL</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="taxaCambio" step="0.01" min="0" value="5.00" 
                               class="w-24 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        <span class="text-xs text-gray-500">1 USD = <span id="taxaDisplay">5,00</span> BRL</span>
                    </div>
                </div>
                <div class="text-gray-600 text-sm font-medium mb-1">üí∞ Valor Total</div>
                <div class="text-3xl font-bold text-green-600" id="totalPayout">R$ 0,00</div>
                <div class="text-xs text-gray-500 mt-1" id="lastUpdate">--:--:--</div>
            </div>
        </div>

        <!-- Visualiza√ß√£o Hier√°rquica Estilo Facebook -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
            <!-- Tabs de Navega√ß√£o -->
            <div class="border-b border-gray-200">
                <div class="flex items-center px-6">
                    <!-- Tab Campanhas -->
                    <button id="tabCampanhas" class="tab-button active px-4 py-3 flex items-center gap-2 border-b-2 border-blue-500 text-blue-600 font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                        </svg>
                        <span>Campanhas</span>
                        <span id="badgeCampanhas" class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full text-xs font-semibold">0</span>
                    </button>
                    
                    <!-- Tab Conjuntos -->
                    <button id="tabConjuntos" class="tab-button px-4 py-3 flex items-center gap-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800 font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                        </svg>
                        <span id="tabConjuntosText">Conjuntos de an√∫ncios</span>
                        <span id="badgeConjuntos" class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs font-semibold hidden">0</span>
                    </button>
                    
                    <!-- Tab An√∫ncios -->
                    <button id="tabAnuncios" class="tab-button px-4 py-3 flex items-center gap-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800 font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"></path>
                        </svg>
                        <span id="tabAnunciosText">An√∫ncios</span>
                        <span id="badgeAnuncios" class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs font-semibold hidden">0</span>
                    </button>
                    
                    <!-- Tab Extrato -->
                    <button id="tabExtrato" class="tab-button px-4 py-3 flex items-center gap-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800 font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>Extrato</span>
                        <span id="badgeExtrato" class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs font-semibold">0</span>
                    </button>
                </div>
            </div>
            
            <!-- Barra de A√ß√µes -->
            <div class="px-6 py-3 bg-gray-50 border-b border-gray-200 flex items-center gap-2">
                <button id="btnSelectAll" class="px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-200 rounded transition-colors">
                    Selecionar tudo
                </button>
                <button id="btnDeselectAll" class="px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-200 rounded transition-colors">
                    Desmarcar tudo
                </button>
                <div class="flex-1"></div>
                <div id="selectedCount" class="text-sm text-gray-600">
                    <span id="selectedCountText">0 selecionado</span>
                </div>
            </div>
            
            <!-- Conte√∫do das Tabs -->
            <div class="p-6">
                <!-- Tab Campanhas -->
                <div id="contentCampanhas" class="tab-content">
                    <div id="campanhasList" class="space-y-2">
                        <div class="text-center text-gray-500 py-8">
                            <p>Carregando campanhas...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Conjuntos -->
                <div id="contentConjuntos" class="tab-content hidden">
                    <div id="conjuntosList" class="space-y-2">
                        <div class="text-center text-gray-500 py-8">
                            <p>Selecione uma campanha para ver os conjuntos</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab An√∫ncios -->
                <div id="contentAnuncios" class="tab-content hidden">
                    <div id="anunciosList" class="space-y-2">
                        <div class="text-center text-gray-500 py-8">
                            <p>Selecione um conjunto para ver os an√∫ncios</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Extrato -->
                <div id="contentExtrato" class="tab-content hidden">
                    <div class="p-6">
                        <div class="mb-4 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">Extrato de Postbacks</h3>
                            <div class="flex items-center gap-4">
                                <button id="btnVerTodosExtrato" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm font-medium">
                                    Ver Todos os Postbacks
                                </button>
                                <div class="text-sm text-gray-600">
                                    Total: <span id="extratoTotal" class="font-semibold">0</span> registros
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campanha</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conjunto</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">An√∫ncio</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lead ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Offer ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payout</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sub IDs</th>
                                    </tr>
                                </thead>
                                <tbody id="extratoTable" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="10" class="px-6 py-8 text-center text-gray-500">
                                            <div class="flex flex-col items-center">
                                                <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <p>Carregando extrato...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de convers√µes -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">Convers√µes</h2>
                <div id="filterInfo" class="text-sm text-gray-600"></div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campanha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conjunto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">An√∫ncio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora</th>
                        </tr>
                    </thead>
                    <tbody id="conversionsTable" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <p>Carregando dados...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 text-center text-gray-500 text-sm">
            <p>Atualiza√ß√£o autom√°tica a cada 10 segundos</p>
        </div>
    </div>

    <script>
        let lastCount = 0;
        let isFirstLoad = true;
        let selectedDate = null;
        let selectedStartDate = null;
        let selectedEndDate = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let datesWithConversions = {}; // { "YYYY-MM-DD": { count, conversoes, leads, total_payout } }
        let dateRangeStart = null;
        let dateRangeEnd = null;
        let produtoSelecionado = null; // Produto selecionado para filtro
        let produtosData = []; // Lista de produtos cadastrados
        let contaSelecionada = null; // Conta selecionada para filtro
        let contasData = []; // Lista de contas do Facebook

        // Fun√ß√£o para formatar data (sem problemas de fuso hor√°rio)
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            // Se j√° est√° no formato YYYY-MM-DD, converter diretamente
            if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}/.test(dateString)) {
                const [year, month, day] = dateString.split('T')[0].split('-');
                return `${day}/${month}/${year}`;
            }
            
            // Para outros formatos, usar Date mas ajustar para evitar problema de fuso hor√°rio
            const date = new Date(dateString);
            // Usar m√©todos locais para garantir data correta
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Fun√ß√£o para formatar hora (fuso hor√°rio Brasil)
        function formatTime(dateString) {
            if (!dateString) return 'N/A';
            try {
                // Se j√° est√° no formato YYYY-MM-DD HH:MM:SS (SQL do Brasil), extrair e formatar diretamente
                if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/.test(dateString)) {
                    // Extrair apenas a parte do hor√°rio (HH:MM:SS)
                    const timePart = dateString.split(' ')[1];
                    let [hours, minutes, seconds] = timePart.split(':');
                    
                    // Validar e corrigir hor√°rios inv√°lidos (24:xx ou maior)
                    hours = parseInt(hours, 10);
                    if (hours >= 24) {
                        // Converter 24:xx para 00:xx (meia-noite do dia seguinte)
                        hours = hours - 24;
                        hours = String(hours).padStart(2, '0');
                    } else {
                        hours = String(hours).padStart(2, '0');
                    }
                    
                    // Validar minutos e segundos
                    minutes = parseInt(minutes, 10);
                    if (minutes >= 60) {
                        minutes = minutes - 60;
                        hours = String(parseInt(hours, 10) + 1).padStart(2, '0');
                    }
                    minutes = String(minutes).padStart(2, '0');
                    
                    seconds = parseInt(seconds, 10);
                    if (seconds >= 60) {
                        seconds = seconds - 60;
                        minutes = String(parseInt(minutes, 10) + 1).padStart(2, '0');
                    }
                    seconds = String(seconds).padStart(2, '0');
                    
                    // Retornar no formato HH:MM:SS (j√° est√° no hor√°rio do Brasil)
                    return `${hours}:${minutes}:${seconds}`;
                }
                // Para outros formatos (ISO, etc), converter para hor√°rio do Brasil
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                const formatter = new Intl.DateTimeFormat('pt-BR', {
                    timeZone: 'America/Sao_Paulo',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                return formatter.format(date);
            } catch (error) {
                console.error('Erro ao formatar hora:', error);
                return 'N/A';
            }
        }
        
        // Fun√ß√£o para obter hora atual do Brasil
        function getBrazilTime() {
            return new Date().toLocaleTimeString('pt-BR', {timeZone: 'America/Sao_Paulo'});
        }

        // Fun√ß√£o para formatar valor monet√°rio em d√≥lar (USD)
        function formatCurrencyUSD(value) {
            if (!value || value === 0) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Fun√ß√£o para formatar valor monet√°rio em Real (BRL) - convers√£o de USD
        // Taxa de c√¢mbio din√¢mica (inicial: 5.00)
        let TAXA_CAMBIO_USD_BRL = 5.0;
        
        // Fun√ß√£o para obter taxa de c√¢mbio atual
        function getTaxaCambio() {
            const input = document.getElementById('taxaCambio');
            if (input) {
                const taxa = parseFloat(input.value) || 5.0;
                TAXA_CAMBIO_USD_BRL = taxa;
                return taxa;
            }
            return TAXA_CAMBIO_USD_BRL;
        }
        
        // Fun√ß√£o para atualizar taxa de c√¢mbio e reconverter todos os valores
        function atualizarTaxaCambio() {
            const novaTaxa = getTaxaCambio();
            console.log('üí± Taxa de c√¢mbio atualizada para:', novaTaxa);
            
            // Atualizar display
            const taxaDisplay = document.getElementById('taxaDisplay');
            if (taxaDisplay) {
                taxaDisplay.textContent = novaTaxa.toFixed(2).replace('.', ',');
            }
            
            // Recarregar dados para atualizar todas as convers√µes
            loadStats();
            loadConversions();
            if (hierarchyData.length > 0) {
                renderCampanhas();
                renderConjuntos();
                renderAnuncios();
            }
            if (currentTab === 'extrato') {
                loadExtrato();
            }
            
            // Atualizar m√©tricas financeiras ap√≥s alterar taxa de c√¢mbio
            updateFinancialMetrics();
        }
        
        function formatCurrencyBRL(value) {
            if (!value || value === 0) return 'R$ 0,00';
            const taxa = getTaxaCambio();
            const valueBRL = value * taxa;
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(valueBRL);
        }
        
        // Fun√ß√£o para formatar valores que J√Å est√£o em BRL (sem convers√£o)
        function formatCurrencyBRLDirect(value) {
            if (!value || value === 0) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Fun√ß√£o para obter badge de status
        function getStatusBadge(status) {
            const badges = {
                'FTD': 'bg-green-100 text-green-800',
                'DEPOSIT': 'bg-blue-100 text-blue-800',
                'PENDING': 'bg-yellow-100 text-yellow-800',
                'REJECTED': 'bg-red-100 text-red-800'
            };
            const color = badges[status] || 'bg-gray-100 text-gray-800';
            return `<span class="px-2 py-1 rounded-full text-xs font-semibold ${color}">${status || 'N/A'}</span>`;
        }

        // Fun√ß√£o para obter nome do m√™s em portugu√™s
        function getMonthName(month) {
            const months = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return months[month];
        }

        // Fun√ß√£o para formatar data como YYYY-MM-DD
        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Fun√ß√£o para verificar se uma data √© hoje
        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        // Fun√ß√£o para renderizar o calend√°rio
        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthName = document.getElementById('currentMonth');
            
            // Atualizar nome do m√™s
            monthName.textContent = `${getMonthName(currentMonth)} ${currentYear}`;

            // Limpar calend√°rio (manter cabe√ßalhos)
            const daysContainer = Array.from(calendar.children).slice(7);
            daysContainer.forEach(day => day.remove());

            // Primeiro dia do m√™s
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            // Adicionar c√©lulas vazias para os dias antes do primeiro dia do m√™s
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'py-1 text-center text-gray-300 text-xs';
                calendar.appendChild(emptyDay);
            }

            // Adicionar os dias do m√™s
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateISO = formatDateISO(date);
                const dayElement = document.createElement('div');
                
                dayElement.className = 'calendar-day py-1 text-center cursor-pointer rounded transition-all text-xs';
                
                // Verificar se tem convers√µes neste dia
                const dayData = datesWithConversions[dateISO];
                if (dayData) {
                    dayElement.classList.add('has-conversions');
                    dayElement.title = `${dayData.count} convers√µes - ${formatCurrencyBRL(dayData.total_payout)}`;
                }

                // Verificar se √© hoje
                if (isToday(date)) {
                    dayElement.classList.add('today');
                }

                // Verificar se est√° no intervalo selecionado
                if (dateRangeStart && dateRangeEnd) {
                    if (dateISO >= dateRangeStart && dateISO <= dateRangeEnd) {
                        dayElement.classList.add('selected');
                    }
                } else if (selectedDate === dateISO) {
                    dayElement.classList.add('selected');
                }

                dayElement.textContent = day;
                dayElement.addEventListener('click', () => {
                    // Se n√£o h√° data inicial, definir como in√≠cio
                    if (!dateRangeStart) {
                        dateRangeStart = dateISO;
                        dateRangeEnd = null;
                        document.getElementById('startDate').value = dateISO;
                        document.getElementById('endDate').value = '';
                        // Definir como data √∫nica e carregar campanhas
                        selectedDate = dateISO;
                        selectedStartDate = null;
                        selectedEndDate = null;
                        loadGastosForDate(dateISO);
                        renderCalendar();
                        loadHierarchy();
                        loadConversions();
                        loadStats();
                        updateFilterInfo();
                    } 
                    // Se h√° in√≠cio mas n√£o fim, definir como fim
                    else if (!dateRangeEnd) {
                        if (dateISO < dateRangeStart) {
                            // Se clicou em data anterior, trocar
                            dateRangeEnd = dateRangeStart;
                            dateRangeStart = dateISO;
                        } else {
                            dateRangeEnd = dateISO;
                        }
                        document.getElementById('startDate').value = dateRangeStart;
                        document.getElementById('endDate').value = dateRangeEnd;
                        // Se for a mesma data, usar selectedDate; sen√£o, usar range
                        if (dateRangeStart === dateRangeEnd) {
                            selectedDate = dateRangeStart;
                            selectedStartDate = null;
                            selectedEndDate = null;
                            loadGastosForDate(dateRangeStart);
                        } else {
                            selectedStartDate = dateRangeStart;
                            selectedEndDate = dateRangeEnd;
                            selectedDate = null;
                            loadGastosForDate(dateRangeStart);
                        }
                        renderCalendar();
                        loadHierarchy();
                        loadConversions();
                        loadStats();
                        updateFilterInfo();
                    } 
                    // Se j√° tem in√≠cio e fim, resetar e come√ßar novo intervalo
                    else {
                        dateRangeStart = dateISO;
                        dateRangeEnd = null;
                        document.getElementById('startDate').value = dateISO;
                        document.getElementById('endDate').value = '';
                        // Definir como data √∫nica e carregar campanhas
                        selectedDate = dateISO;
                        selectedStartDate = null;
                        selectedEndDate = null;
                        loadGastosForDate(dateISO);
                        renderCalendar();
                        loadHierarchy();
                        loadConversions();
                        loadStats();
                        updateFilterInfo();
                    }
                });
                
                calendar.appendChild(dayElement);
            }
        }

        // Fun√ß√£o para aplicar op√ß√£o r√°pida de data
        function applyQuickDate(option) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let start, end;
            
            switch(option) {
                case 'today':
                    start = end = formatDateISO(today);
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    start = end = formatDateISO(yesterday);
                    break;
                case 'last7days':
                    end = formatDateISO(today);
                    const last7 = new Date(today);
                    last7.setDate(last7.getDate() - 6);
                    start = formatDateISO(last7);
                    break;
                case 'last14days':
                    end = formatDateISO(today);
                    const last14 = new Date(today);
                    last14.setDate(last14.getDate() - 13);
                    start = formatDateISO(last14);
                    break;
                case 'last30days':
                    end = formatDateISO(today);
                    const last30 = new Date(today);
                    last30.setDate(last30.getDate() - 29);
                    start = formatDateISO(last30);
                    break;
                case 'thisWeek':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    start = formatDateISO(weekStart);
                    end = formatDateISO(today);
                    break;
                case 'lastWeek':
                    const lastWeekEnd = new Date(today);
                    lastWeekEnd.setDate(today.getDate() - today.getDay() - 1);
                    const lastWeekStart = new Date(lastWeekEnd);
                    lastWeekStart.setDate(lastWeekEnd.getDate() - 6);
                    start = formatDateISO(lastWeekStart);
                    end = formatDateISO(lastWeekEnd);
                    break;
                case 'thisMonth':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    start = formatDateISO(monthStart);
                    end = formatDateISO(today);
                    break;
                case 'lastMonth':
                    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                    const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    start = formatDateISO(lastMonthStart);
                    end = formatDateISO(lastMonthEnd);
                    break;
                default:
                    return;
            }
            
            dateRangeStart = start;
            dateRangeEnd = end;
            document.getElementById('startDate').value = start;
            document.getElementById('endDate').value = end;
            
            // Se for a mesma data (data √∫nica), usar selectedDate; sen√£o, usar range
            if (start === end) {
                selectedDate = start;
                selectedStartDate = null;
                selectedEndDate = null;
                loadGastosForDate(start);
            } else {
                selectedStartDate = start;
                selectedEndDate = end;
                selectedDate = null;
                loadGastosForDate(start);
            }
            
            // Atualizar m√™s do calend√°rio para mostrar a data inicial
            const startDateObj = new Date(start);
            currentMonth = startDateObj.getMonth();
            currentYear = startDateObj.getFullYear();
            
            renderCalendar();
            loadHierarchy();
            loadConversions();
            loadStats();
            updateFilterInfo();
        }

        // Fun√ß√£o para carregar datas com convers√µes
        async function loadDatesWithConversions() {
            try {
                const response = await fetch('/api/conversions/dates');
                const data = await response.json();
                
                // Converter array em objeto para acesso r√°pido
                datesWithConversions = {};
                data.forEach(item => {
                    datesWithConversions[item.date] = {
                        count: item.count,
                        leads: item.leads,
                        conversoes: item.conversoes,
                        total_payout: item.total_payout
                    };
                });
                
                renderCalendar();
            } catch (error) {
                console.error('Erro ao carregar datas:', error);
            }
        }

        // Fun√ß√£o para carregar estat√≠sticas
        async function loadStats() {
            try {
                let url = '/api/stats';
                const params = [];
                
                // Filtro por produto (prioridade)
                if (produtoSelecionado) {
                    params.push(`offerId=${produtoSelecionado.offerId}`);
                }
                
                // Filtro por conta (usar categoria que √© preenchida com nome_conta do produto)
                if (contaSelecionada) {
                    params.push(`categoria=${encodeURIComponent(contaSelecionada)}`);
                }
                
                // Filtro por data
                if (selectedStartDate && selectedEndDate) {
                    params.push(`startDate=${selectedStartDate}`, `endDate=${selectedEndDate}`);
                } else if (selectedDate) {
                    params.push(`date=${selectedDate}`);
                }
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }
                
                const response = await fetch(url);
                let stats = await response.json();
                
                // Se houver filtro de hierarquia, calcular estat√≠sticas dos itens selecionados
                if (selectedAnuncios.size > 0 || selectedConjuntos.size > 0 || selectedCampanhas.size > 0) {
                    // Buscar convers√µes e calcular estat√≠sticas
                    const conversionsResponse = await fetch(url.replace('/api/stats', '/api/conversions'));
                    let conversions = await conversionsResponse.json();
                    
                    // Aplicar mesmo filtro de hierarquia
                    if (selectedAnuncios.size > 0) {
                        conversions = conversions.filter(item => {
                            const key = `${item.campanha || 'N/A'}::${item.conjunto || 'N/A'}::${item.anuncio || 'N/A'}`;
                            return selectedAnuncios.has(key);
                        });
                    } else if (selectedConjuntos.size > 0) {
                        conversions = conversions.filter(item => {
                            const key = `${item.campanha || 'N/A'}::${item.conjunto || 'N/A'}`;
                            return selectedConjuntos.has(key);
                        });
                    } else if (selectedCampanhas.size > 0) {
                        conversions = conversions.filter(item => {
                            return selectedCampanhas.has(item.campanha || 'N/A');
                        });
                    }
                    
                    // Recalcular estat√≠sticas
                    // IMPORTANTE: total_payout conta APENAS leads aprovados (conversao/approval)
                    stats = {
                        total_leads: conversions.length,
                        leads: conversions.filter(c => c.notification_type === 'lead').length,
                        leads_confirmados: conversions.filter(c => c.notification_type === 'conversao' || c.notification_type === 'approval').length,
                        leads_cancelados: conversions.filter(c => c.notification_type === 'cancel' || c.notification_type === 'rejection').length,
                        leads_trash: conversions.filter(c => c.notification_type === 'trash').length,
                        total_payout: conversions
                            .filter(c => c.notification_type === 'conversao' || c.notification_type === 'approval')
                            .reduce((sum, c) => sum + (parseFloat(c.payout) || 0), 0)
                    };
                }
                
                document.getElementById('totalLeads').textContent = stats.total_leads || 0;
                document.getElementById('leadsConfirmados').textContent = stats.leads_confirmados || 0;
                document.getElementById('leadsCancelados').textContent = stats.leads_cancelados || 0;
                document.getElementById('leadsTrash').textContent = stats.leads_trash || 0;
                document.getElementById('totalPayout').textContent = formatCurrencyBRL(stats.total_payout || 0);
                
                // Atualizar m√©tricas financeiras
                updateFinancialMetrics();
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }
        
        // Fun√ß√£o para atualizar m√©tricas financeiras (Total de Gasto, Vendas, ROAS, Lucro)
        function updateFinancialMetrics() {
            try {
                // Calcular total de gastos (soma de todos os gastos do XLSX)
                let totalGastosBRL = 0;
                campanhasGastos.forEach(gastos => {
                    totalGastosBRL += gastos || 0;
                });
                
                // Calcular total de vendas (soma de todos os payouts das campanhas)
                let totalVendasUSD = 0;
                hierarchyData.forEach(campanha => {
                    totalVendasUSD += campanha.total_payout || 0;
                });
                
                // Converter vendas para BRL
                const taxa = getTaxaCambio();
                const totalVendasBRL = totalVendasUSD * taxa;
                
                // Calcular ROAS
                const roas = totalGastosBRL > 0 ? (totalVendasBRL / totalGastosBRL).toFixed(2) : 0;
                
                // Calcular Lucro
                const lucroBRL = totalVendasBRL - totalGastosBRL;
                
                // Atualizar elementos na tela
                document.getElementById('totalGastosConta').textContent = formatCurrencyBRLDirect(totalGastosBRL);
                document.getElementById('totalVendasBRL').textContent = formatCurrencyBRLDirect(totalVendasBRL);
                document.getElementById('totalVendasUSD').textContent = formatCurrencyUSD(totalVendasUSD);
                
                // Atualizar ROAS com cor (verde se >= 1x, vermelho se < 1x)
                const roasElement = document.getElementById('roasConta');
                roasElement.textContent = totalGastosBRL > 0 ? roas + 'x' : 'N/A';
                roasElement.className = 'text-3xl font-bold ' + (totalGastosBRL > 0 && parseFloat(roas) >= 1 ? 'text-green-600' : 'text-red-600');
                
                // Atualizar Lucro com cor (verde se positivo, vermelho se negativo)
                const lucroElement = document.getElementById('lucroConta');
                lucroElement.textContent = formatCurrencyBRLDirect(lucroBRL);
                lucroElement.className = 'text-3xl font-bold ' + (lucroBRL >= 0 ? 'text-green-600' : 'text-red-600');
                
                // Calcular Taxa de Aprova√ß√£o
                // Taxa de Aprova√ß√£o = (Leads Confirmados / Total de Leads) √ó 100
                const totalLeads = parseInt(document.getElementById('totalLeads').textContent) || 0;
                const leadsConfirmados = parseInt(document.getElementById('leadsConfirmados').textContent) || 0;
                let taxaAprovacao = 0;
                if (totalLeads > 0) {
                    taxaAprovacao = (leadsConfirmados / totalLeads) * 100;
                }
                document.getElementById('taxaAprovacao').textContent = taxaAprovacao.toFixed(2) + '%';
                
                console.log('üí∞ M√©tricas financeiras atualizadas:', {
                    totalGastosBRL,
                    totalVendasUSD,
                    totalVendasBRL,
                    roas,
                    lucroBRL,
                    taxaAprovacao
                });
            } catch (error) {
                console.error('‚ùå Erro ao atualizar m√©tricas financeiras:', error);
            }
        }

        // Fun√ß√£o para carregar convers√µes
        async function loadConversions() {
            try {
                let url = '/api/conversions';
                const params = [];
                
                // Filtro por produto (prioridade)
                if (produtoSelecionado) {
                    params.push(`offerId=${produtoSelecionado.offerId}`);
                }
                
                // Filtro de data
                if (selectedStartDate && selectedEndDate) {
                    params.push(`startDate=${selectedStartDate}`, `endDate=${selectedEndDate}`);
                } else if (selectedDate) {
                    params.push(`date=${selectedDate}`);
                }
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }
                
                const response = await fetch(url);
                let data = await response.json();
                
                // Filtrar por hierarquia selecionada
                if (selectedAnuncios.size > 0) {
                    // Filtrar por an√∫ncios selecionados
                    data = data.filter(item => {
                        const key = `${item.campanha || 'N/A'}::${item.conjunto || 'N/A'}::${item.anuncio || 'N/A'}`;
                        return selectedAnuncios.has(key);
                    });
                } else if (selectedConjuntos.size > 0) {
                    // Filtrar por conjuntos selecionados
                    data = data.filter(item => {
                        const key = `${item.campanha || 'N/A'}::${item.conjunto || 'N/A'}`;
                        return selectedConjuntos.has(key);
                    });
                } else if (selectedCampanhas.size > 0) {
                    // Filtrar por campanhas selecionadas
                    data = data.filter(item => {
                        return selectedCampanhas.has(item.campanha || 'N/A');
                    });
                }

                // Verificar se h√° novos dados (apenas se n√£o houver filtro)
                if (!selectedDate && !selectedStartDate && !isFirstLoad && data.length > lastCount) {
                    showAlert();
                }
                lastCount = data.length;
                isFirstLoad = false;

                // Atualizar tabela
                updateTable(data);

                // Atualizar timestamp
                document.getElementById('lastUpdate').textContent = getBrazilTime();

                // Atualizar informa√ß√£o de filtro
                updateFilterInfo();
            } catch (error) {
                console.error('Erro ao carregar convers√µes:', error);
            }
        }

        // Fun√ß√£o para atualizar informa√ß√£o do filtro
        function updateFilterInfo() {
            const filterInfo = document.getElementById('filterInfo');
            const selectedPeriodText = document.getElementById('selectedPeriodText');
            const datePickerText = document.getElementById('datePickerText');
            const currentDateDisplay = document.getElementById('currentDateDisplay');
            
            // Verificar se os elementos existem antes de usar
            if (!filterInfo || !selectedPeriodText || !datePickerText) {
                return; // Elementos n√£o encontrados, sair da fun√ß√£o
            }
            
            let filterParts = [];
            
            // Filtro de data
            if (selectedStartDate && selectedEndDate) {
                if (selectedStartDate === selectedEndDate) {
                    filterParts.push(`Data: ${formatDate(selectedStartDate)}`);
                } else {
                    filterParts.push(`Data: ${formatDate(selectedStartDate)} at√© ${formatDate(selectedEndDate)}`);
                }
            } else if (selectedDate) {
                filterParts.push(`Data: ${formatDate(selectedDate)}`);
            }
            
            // Filtro de hierarquia
            if (selectedAnuncios && selectedAnuncios.size > 0) {
                filterParts.push(`${selectedAnuncios.size} an√∫ncio${selectedAnuncios.size > 1 ? 's' : ''} selecionado${selectedAnuncios.size > 1 ? 's' : ''}`);
            } else if (selectedConjuntos && selectedConjuntos.size > 0) {
                filterParts.push(`${selectedConjuntos.size} conjunto${selectedConjuntos.size > 1 ? 's' : ''} selecionado${selectedConjuntos.size > 1 ? 's' : ''}`);
            } else if (selectedCampanhas && selectedCampanhas.size > 0) {
                filterParts.push(`${selectedCampanhas.size} campanha${selectedCampanhas.size > 1 ? 's' : ''} selecionada${selectedCampanhas.size > 1 ? 's' : ''}`);
            }
            
            const filterText = filterParts.length > 0 ? filterParts.join(' ‚Ä¢ ') : 'Mostrando todas as convers√µes';
            filterInfo.textContent = filterText;
            selectedPeriodText.textContent = filterText;
            
            // Atualizar date picker
            if (selectedStartDate && selectedEndDate) {
                if (selectedStartDate === selectedEndDate) {
                    datePickerText.textContent = formatDate(selectedStartDate);
                } else {
                    datePickerText.textContent = `${formatDate(selectedStartDate)} - ${formatDate(selectedEndDate)}`;
                }
            } else if (selectedDate) {
                datePickerText.textContent = formatDate(selectedDate);
            } else {
                const today = new Date();
                if (currentDateDisplay) {
                    currentDateDisplay.textContent = formatDate(formatDateISO(today));
                }
                datePickerText.textContent = `Hoje: ${formatDate(formatDateISO(today))}`;
            }
        }


        // Fun√ß√£o para atualizar tabela
        function updateTable(data) {
            const tbody = document.getElementById('conversionsTable');
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                </svg>
                                <p>Nenhuma convers√£o encontrada</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map(item => {
                // Hierarquia: Campanha (N√≠vel 1) > Conjunto (N√≠vel 2) > An√∫ncio (N√≠vel 3)
                // Prioridade: campos mapeados > sub_ids hier√°rquicos
                const campanha = item.campanha || item.sub_id6 || item.sub_id3 || 'N/A';
                const conjunto = item.conjunto || item.sub_id5 || 'N/A';
                const anuncio = item.anuncio || item.sub_id4 || 'N/A';
                
                // Badge de tipo de notifica√ß√£o
                const notificationType = item.notification_type || 'lead';
                const typeBadge = {
                    'lead': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">Lead</span>',
                    'conversao': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Confirmado</span>',
                    'approval': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Confirmado</span>',
                    'cancel': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">Cancelado</span>',
                    'rejection': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">Cancelado</span>',
                    'trash': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-800">Trash</span>'
                };
                const typeDisplay = typeBadge[notificationType] || typeBadge['lead'];
                
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="font-semibold text-gray-900">${campanha}</div>
                        <div class="text-xs text-gray-500 mt-1">üìä Campanha</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="text-gray-900">${conjunto}</div>
                        <div class="text-xs text-gray-500 mt-1">üìÅ Conjunto</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="text-gray-900">${anuncio}</div>
                        <div class="text-xs text-gray-500 mt-1">üìÑ An√∫ncio</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="mb-1">${typeDisplay}</div>
                        <div>${getStatusBadge(item.status)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${formatCurrencyBRL(item.payout)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(item.date || item.created_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatTime(item.created_at)}</td>
                </tr>
            `;
            }).join('');
        }

        // Fun√ß√£o para mostrar alerta
        function showAlert() {
            const alert = document.getElementById('alert');
            alert.classList.remove('hidden');
            alert.classList.add('slide-down', 'pulse-green');
            
            // Atualizar extrato se estiver na aba de extrato
            if (currentTab === 'extrato') {
                loadExtrato();
            }
            
            setTimeout(() => {
                alert.classList.add('hidden');
                alert.classList.remove('pulse-green');
            }, 5000);
        }

        // Event Listeners
        // Abrir modal de date picker
        document.getElementById('datePickerBtn').addEventListener('click', () => {
            document.getElementById('datePickerModal').classList.remove('hidden');
            // Resetar sele√ß√£o ao abrir
            dateRangeStart = selectedStartDate;
            dateRangeEnd = selectedEndDate;
            if (selectedStartDate) {
                document.getElementById('startDate').value = selectedStartDate;
                // Mostrar m√™s da data inicial
                const startDateObj = new Date(selectedStartDate);
                currentMonth = startDateObj.getMonth();
                currentYear = startDateObj.getFullYear();
            } else {
                // Mostrar m√™s atual
                const today = new Date();
                currentMonth = today.getMonth();
                currentYear = today.getFullYear();
            }
            if (selectedEndDate) {
                document.getElementById('endDate').value = selectedEndDate;
            }
            renderCalendar();
        });

        // Fechar modal
        document.getElementById('closeDatePicker').addEventListener('click', () => {
            document.getElementById('datePickerModal').classList.add('hidden');
        });

        document.getElementById('cancelDatePicker').addEventListener('click', () => {
            document.getElementById('datePickerModal').classList.add('hidden');
            // Restaurar valores anteriores
            dateRangeStart = selectedStartDate;
            dateRangeEnd = selectedEndDate;
        });

        // Aplicar filtro de data
        document.getElementById('applyDatePicker').addEventListener('click', () => {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                selectedStartDate = startDate;
                selectedEndDate = endDate;
                selectedDate = null;
            } else if (startDate) {
                selectedDate = startDate;
                selectedStartDate = null;
                selectedEndDate = null;
            } else {
                selectedDate = null;
                selectedStartDate = null;
                selectedEndDate = null;
            }
            
            document.getElementById('datePickerModal').classList.add('hidden');
            // Carregar gastos para a data selecionada antes de carregar hierarquia
            if (selectedDate) {
                loadGastosForDate(selectedDate);
            } else if (selectedStartDate) {
                loadGastosForDate(selectedStartDate);
            }
            loadHierarchy();
            loadConversions();
            loadStats();
            if (currentTab === 'extrato') {
                loadExtrato();
            }
            updateFilterInfo();
        });

        // Op√ß√µes r√°pidas
        document.querySelectorAll('input[name="quickDate"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    applyQuickDate(e.target.value);
                }
            });
        });

        // Campos de data
        document.getElementById('startDate').addEventListener('change', (e) => {
            dateRangeStart = e.target.value;
            if (dateRangeStart && dateRangeEnd && dateRangeStart > dateRangeEnd) {
                dateRangeEnd = dateRangeStart;
                document.getElementById('endDate').value = dateRangeEnd;
            }
            renderCalendar();
        });

        document.getElementById('endDate').addEventListener('change', (e) => {
            dateRangeEnd = e.target.value;
            if (dateRangeStart && dateRangeEnd && dateRangeStart > dateRangeEnd) {
                dateRangeStart = dateRangeEnd;
                document.getElementById('startDate').value = dateRangeStart;
            }
            renderCalendar();
        });

        // Navega√ß√£o do calend√°rio
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        });

        // Bot√£o para resetar filtro
        document.getElementById('resetFilter').addEventListener('click', () => {
            selectedDate = null;
            selectedStartDate = null;
            selectedEndDate = null;
            dateRangeStart = null;
            dateRangeEnd = null;
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.querySelectorAll('input[name="quickDate"]').forEach(radio => radio.checked = false);
            renderCalendar();
            // Limpar campanhas quando n√£o houver data selecionada
            hierarchyData = [];
            renderCampanhas();
            updateBadges();
            updateTabTexts();
            // Carregar convers√µes e stats sem filtro de data
            loadConversions();
            loadStats();
            if (currentTab === 'extrato') {
                loadExtrato();
            }
            updateFilterInfo();
        });

        // Fechar modal ao clicar fora
        document.getElementById('datePickerModal').addEventListener('click', (e) => {
            if (e.target.id === 'datePickerModal') {
                document.getElementById('datePickerModal').classList.add('hidden');
            }
        });

        // ============================================
        // GERENCIAMENTO DE HIERARQUIA (Estilo Facebook)
        // ============================================
        let hierarchyData = [];
        let selectedCampanhas = new Set();
        let selectedConjuntos = new Set();
        let selectedAnuncios = new Set();
        let currentTab = 'campanhas';
        let campanhasGastos = new Map(); // Armazenar gastos por campanha para a data atual: { nomeCampanha: gastos }
        
        // Fun√ß√£o para carregar gastos salvos do localStorage
        function loadGastosFromStorage() {
            try {
                const saved = localStorage.getItem('metaAdsGastos');
                return saved ? JSON.parse(saved) : {};
            } catch (error) {
                console.error('‚ùå Erro ao carregar gastos do localStorage:', error);
                return {};
            }
        }
        
        // Fun√ß√£o para salvar gastos no localStorage
        function saveGastosToStorage(gastosPorData) {
            try {
                localStorage.setItem('metaAdsGastos', JSON.stringify(gastosPorData));
                console.log('üíæ Gastos salvos no localStorage');
            } catch (error) {
                console.error('‚ùå Erro ao salvar gastos no localStorage:', error);
            }
        }
        
        // Fun√ß√£o para carregar gastos da data selecionada
        function loadGastosForDate(date) {
            if (!date) {
                campanhasGastos.clear();
                return;
            }
            
            const gastosPorData = loadGastosFromStorage();
            const gastosDaData = gastosPorData[date] || {};
            
            // Limpar e preencher o Map com os gastos da data
            campanhasGastos.clear();
            Object.keys(gastosDaData).forEach(campanha => {
                campanhasGastos.set(campanha, gastosDaData[campanha]);
            });
            
            console.log(`üí∞ Gastos carregados para ${date}:`, Array.from(campanhasGastos.entries()));
        }
        
        // Fun√ß√£o para converter data para formato YYYY-MM-DD (usada no processamento XLSX)
        function parseDateToISO(dateValue) {
            if (!dateValue) return null;
            
            // Se j√° for string no formato YYYY-MM-DD
            if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}/.test(dateValue)) {
                return dateValue.split('T')[0];
            }
            
            // Se for n√∫mero (Excel serial date)
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                return formatDateISO(date);
            }
            
            // Tentar parsear como data
            const date = new Date(dateValue);
            if (!isNaN(date.getTime())) {
                return formatDateISO(date);
            }
            
            // Tentar parsear formato brasileiro DD/MM/YYYY
            if (typeof dateValue === 'string') {
                const parts = dateValue.split(/[\/\-]/);
                if (parts.length === 3) {
                    // Assumir formato DD/MM/YYYY ou DD-MM-YYYY
                    const day = parts[0].padStart(2, '0');
                    const month = parts[1].padStart(2, '0');
                    const year = parts[2].length === 4 ? parts[2] : `20${parts[2]}`;
                    return `${year}-${month}-${day}`;
                }
            }
            
            return null;
        }

        // Carregar hierarquia
        async function loadHierarchy() {
            try {
                let url = '/api/hierarchy';
                const params = [];
                
                // Filtro por produto (prioridade)
                if (produtoSelecionado) {
                    params.push(`offerId=${produtoSelecionado.offerId}`);
                }
                
                // IMPORTANTE: Apenas carregar se houver data selecionada
                // A data √© baseada no POSTBACK (date/created_at), n√£o no nome da campanha
                // Se for range de datas, usar a data inicial (ou a √∫nica data se forem iguais)
                let dateToUse = null;
                if (selectedDate) {
                    dateToUse = selectedDate;
                } else if (selectedStartDate && selectedEndDate) {
                    // Se for range, usar a data inicial (ou ambas se a API suportar)
                    // Por enquanto, usar apenas a data inicial para filtrar
                    dateToUse = selectedStartDate;
                }
                
                // Se n√£o houver data selecionada, n√£o carregar campanhas
                if (!dateToUse) {
                    hierarchyData = [];
                    renderCampanhas();
                    updateBadges();
                    updateTabTexts();
                    return;
                }
                
                params.push(`date=${dateToUse}`);
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }
                
                console.log('üìÖ Carregando campanhas para a data:', dateToUse);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                hierarchyData = await response.json();
                console.log('üìä Hierarquia carregada:', hierarchyData);
                console.log('üìä Total de campanhas:', hierarchyData.length);
                
                // Carregar gastos salvos para a data selecionada
                if (dateToUse) {
                    loadGastosForDate(dateToUse);
                }
                
                renderCampanhas();
                updateBadges();
                updateTabTexts();
                
                // Atualizar m√©tricas financeiras ap√≥s carregar hierarquia
                updateFinancialMetrics();
            } catch (error) {
                console.error('‚ùå Erro ao carregar hierarquia:', error);
                const list = document.getElementById('campanhasList');
                if (list) {
                    list.innerHTML = `<div class="text-center text-red-500 py-8"><p>Erro ao carregar campanhas: ${error.message}</p></div>`;
                }
            }
        }

        // Renderizar campanhas
        function renderCampanhas() {
            const list = document.getElementById('campanhasList');
            if (!list) {
                console.error('‚ùå Elemento campanhasList n√£o encontrado');
                return;
            }
            
            // Verificar se h√° data selecionada
            const hasDateSelected = selectedDate || (selectedStartDate && selectedEndDate);
            
            if (!hasDateSelected) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8"><p>Selecione uma data para visualizar as campanhas.</p></div>';
                return;
            }
            
            if (hierarchyData.length === 0) {
                const dateDisplay = selectedDate ? formatDate(selectedDate) : 
                                  (selectedStartDate && selectedEndDate ? 
                                   `${formatDate(selectedStartDate)} at√© ${formatDate(selectedEndDate)}` : '');
                list.innerHTML = `<div class="text-center text-gray-500 py-8"><p>Nenhuma campanha com leads encontrada para a data selecionada (${dateDisplay}).</p><p class="text-sm mt-2">As campanhas s√£o exibidas apenas se tiverem recebido leads na data do postback.</p></div>`;
                return;
            }

            list.innerHTML = hierarchyData.map(campanha => {
                const isSelected = selectedCampanhas.has(campanha.nome);
                // Normalizar nome: se for "sem-trackeamento", mostrar "untracked"
                const nomeExibido = campanha.nome === 'sem-trackeamento' || campanha.nome === 'Sem Campanha' 
                    ? 'untracked' 
                    : campanha.nome;
                
                // Coletar todos os conjuntos e an√∫ncios para exibir
                const todosConjuntos = [];
                const todosAnuncios = [];
                campanha.conjuntos.forEach(conjunto => {
                    const conjuntoNome = conjunto.nome === 'sem-trackeamento' ? 'untracked' : conjunto.nome;
                    todosConjuntos.push(conjuntoNome);
                    conjunto.anuncios.forEach(anuncio => {
                        const anuncioNome = anuncio.nome === 'sem-trackeamento' ? 'untracked' : anuncio.nome;
                        todosAnuncios.push(`${conjuntoNome} > ${anuncioNome}`);
                    });
                });
                
                // Se n√£o tiver conjuntos, mostrar apenas campanha
                const conjuntosTexto = todosConjuntos.length > 0 
                    ? todosConjuntos.join(', ') 
                    : 'untracked';
                const anunciosTexto = todosAnuncios.length > 0 
                    ? todosAnuncios.join(' | ') 
                    : 'untracked';
                
                return `
                    <div class="hierarchy-item ${isSelected ? 'selected' : ''} border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50" data-campanha="${campanha.nome}">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" class="w-4 h-4 text-blue-600 rounded mt-1" ${isSelected ? 'checked' : ''} 
                                   onchange="toggleCampanha('${campanha.nome.replace(/'/g, "\\'")}', this.checked)">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900 text-lg mb-2">üìä ${nomeExibido}</div>
                                
                                <div class="bg-gray-50 rounded-lg p-3 mb-2">
                                    <div class="text-sm text-gray-700 mb-1">
                                        <span class="font-medium">Conjunto:</span> 
                                        <span class="text-gray-600">${conjuntosTexto}</span>
                                    </div>
                                    <div class="text-sm text-gray-700">
                                        <span class="font-medium">An√∫ncio:</span> 
                                        <span class="text-gray-600">${anunciosTexto}</span>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-3 text-sm mb-2">
                                    <div class="flex flex-col">
                                        <span class="text-gray-600 text-xs mb-1">üìà Leads</span>
                                        <span class="font-semibold text-blue-600 text-base">${campanha.leads}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-gray-600 text-xs mb-1">‚úÖ Convers√µes</span>
                                        <span class="font-semibold text-green-600 text-base">${campanha.conversoes}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-gray-600 text-xs mb-1">üí∞ Valor</span>
                                        <span class="font-semibold text-green-600 text-base">${formatCurrencyBRL(campanha.total_payout)}</span>
                                    </div>
                                    ${campanhasGastos.has(campanha.nome) ? (() => {
                                        // Gastos j√° est√£o em BRL (do XLSX)
                                        const gastosBRL = campanhasGastos.get(campanha.nome);
                                        // Converter payout de USD para BRL
                                        const taxa = getTaxaCambio();
                                        const payoutBRL = campanha.total_payout * taxa;
                                        // Calcular m√©tricas
                                        const lucroBRL = payoutBRL - gastosBRL;
                                        const roas = gastosBRL > 0 ? (payoutBRL / gastosBRL).toFixed(2) : 0;
                                        const custoPorLead = campanha.leads > 0 ? gastosBRL / campanha.leads : 0;
                                        
                                        return `
                                    <div class="flex flex-col">
                                        <span class="text-gray-600 text-xs mb-1">üí∏ Gastos</span>
                                        <span class="font-semibold text-red-600 text-base">${formatCurrencyBRLDirect(gastosBRL)}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-gray-600 text-xs mb-1">üìä Custo/Lead</span>
                                        <span class="font-semibold ${campanha.leads > 0 ? 'text-orange-600' : 'text-gray-400'} text-base">${campanha.leads > 0 ? formatCurrencyBRLDirect(custoPorLead) : 'N/A'}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-gray-600 text-xs mb-1">üíµ Lucro</span>
                                        <span class="font-semibold ${lucroBRL >= 0 ? 'text-green-600' : 'text-red-600'} text-base">${formatCurrencyBRLDirect(lucroBRL)}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-gray-600 text-xs mb-1">üìà ROAS</span>
                                        <span class="font-semibold ${gastosBRL > 0 && parseFloat(roas) >= 1 ? 'text-green-600' : 'text-red-600'} text-base">${gastosBRL > 0 ? roas + 'x' : 'N/A'}</span>
                                    </div>
                                    `;
                                    })() : `
                                    <div class="flex flex-col col-span-4">
                                        <span class="text-gray-500 text-xs">üìÅ Conjuntos: ${campanha.conjuntos.length}</span>
                                        <span class="text-gray-400 text-xs mt-1">Fa√ßa upload do XLSX para ver gastos e m√©tricas</span>
                                    </div>
                                    `}
                                </div>
                            </div>
                            ${campanha.conjuntos.length > 0 ? `
                            <button onclick="viewConjuntos('${campanha.nome.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm whitespace-nowrap">
                                Ver Conjuntos ‚Üí
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Renderizar conjuntos
        function renderConjuntos() {
            const list = document.getElementById('conjuntosList');
            const campanhasSelecionadas = hierarchyData.filter(c => selectedCampanhas.has(c.nome));
            
            if (campanhasSelecionadas.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8"><p>Selecione uma campanha para ver os conjuntos</p></div>';
                return;
            }

            const conjuntos = [];
            campanhasSelecionadas.forEach(campanha => {
                campanha.conjuntos.forEach(conjunto => {
                    conjuntos.push({...conjunto, campanha: campanha.nome});
                });
            });

            if (conjuntos.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8"><p>Nenhum conjunto encontrado nas campanhas selecionadas</p></div>';
                return;
            }

            list.innerHTML = conjuntos.map(conjunto => {
                const key = `${conjunto.campanha}::${conjunto.nome}`;
                const isSelected = selectedConjuntos.has(key);
                return `
                    <div class="hierarchy-item ${isSelected ? 'selected' : ''} border border-gray-200 rounded-lg p-4 cursor-pointer" data-conjunto="${key}">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" class="w-4 h-4 text-blue-600 rounded" ${isSelected ? 'checked' : ''} 
                                   onchange="toggleConjunto('${key}', this.checked)">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900">${conjunto.nome}</div>
                                <div class="text-xs text-gray-500 mt-1">Campanha: ${conjunto.campanha}</div>
                                <div class="text-sm text-gray-500 mt-1">
                                    ${conjunto.anuncios.length} an√∫ncio(s) ‚Ä¢ 
                                    ${conjunto.total} total ‚Ä¢ 
                                    ${conjunto.conversoes} convers√µes ‚Ä¢ 
                                    ${formatCurrencyBRL(conjunto.total_payout)}
                                </div>
                            </div>
                            <button onclick="viewAnuncios('${key}')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm">
                                Ver An√∫ncios ‚Üí
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Renderizar an√∫ncios
        function renderAnuncios() {
            const list = document.getElementById('anunciosList');
            const conjuntosSelecionados = [];
            
            hierarchyData.forEach(campanha => {
                campanha.conjuntos.forEach(conjunto => {
                    const key = `${campanha.nome}::${conjunto.nome}`;
                    if (selectedConjuntos.has(key)) {
                        conjunto.anuncios.forEach(anuncio => {
                            conjuntosSelecionados.push({...anuncio, conjunto: conjunto.nome, campanha: campanha.nome});
                        });
                    }
                });
            });

            if (conjuntosSelecionados.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8"><p>Selecione um conjunto para ver os an√∫ncios</p></div>';
                return;
            }

            list.innerHTML = conjuntosSelecionados.map(anuncio => {
                const key = `${anuncio.campanha}::${anuncio.conjunto}::${anuncio.nome}`;
                const isSelected = selectedAnuncios.has(key);
                return `
                    <div class="hierarchy-item ${isSelected ? 'selected' : ''} border border-gray-200 rounded-lg p-4 cursor-pointer" data-anuncio="${key}">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" class="w-4 h-4 text-blue-600 rounded" ${isSelected ? 'checked' : ''} 
                                   onchange="toggleAnuncio('${key}', this.checked)">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900">${anuncio.nome}</div>
                                <div class="text-xs text-gray-500 mt-1">
                                    Campanha: ${anuncio.campanha} ‚Ä¢ Conjunto: ${anuncio.conjunto}
                                </div>
                                <div class="text-sm text-gray-500 mt-1">
                                    ${anuncio.total} total ‚Ä¢ 
                                    ${anuncio.conversoes} convers√µes ‚Ä¢ 
                                    ${formatCurrencyBRL(anuncio.total_payout)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Fun√ß√µes de toggle (tornar globais)
        window.toggleCampanha = function(nome, checked) {
            if (checked) {
                selectedCampanhas.add(nome);
            } else {
                selectedCampanhas.delete(nome);
                // Remover conjuntos e an√∫ncios dessa campanha
                hierarchyData.find(c => c.nome === nome)?.conjuntos.forEach(conj => {
                    selectedConjuntos.delete(`${nome}::${conj.nome}`);
                    conj.anuncios.forEach(anuncio => {
                        selectedAnuncios.delete(`${nome}::${conj.nome}::${anuncio.nome}`);
                    });
                });
            }
            renderCampanhas();
            renderConjuntos();
            renderAnuncios();
            updateSelectedCount();
            updateTabTexts();
            filterConversions();
        };

        window.toggleConjunto = function(key, checked) {
            if (checked) {
                selectedConjuntos.add(key);
            } else {
                selectedConjuntos.delete(key);
                // Remover an√∫ncios desse conjunto
                const [campanha, conjunto] = key.split('::');
                hierarchyData.find(c => c.nome === campanha)?.conjuntos
                    .find(conj => conj.nome === conjunto)?.anuncios.forEach(anuncio => {
                        selectedAnuncios.delete(`${campanha}::${conjunto}::${anuncio.nome}`);
                    });
            }
            renderConjuntos();
            renderAnuncios();
            updateSelectedCount();
            updateTabTexts();
            filterConversions();
        };

        window.toggleAnuncio = function(key, checked) {
            if (checked) {
                selectedAnuncios.add(key);
            } else {
                selectedAnuncios.delete(key);
            }
            renderAnuncios();
            updateSelectedCount();
            updateTabTexts();
            filterConversions();
        };

        window.viewConjuntos = function(campanhaNome) {
            if (!selectedCampanhas.has(campanhaNome)) {
                selectedCampanhas.add(campanhaNome);
                renderCampanhas();
            }
            updateTabTexts();
            switchTab('conjuntos');
        };

        window.viewAnuncios = function(conjuntoKey) {
            if (!selectedConjuntos.has(conjuntoKey)) {
                selectedConjuntos.add(conjuntoKey);
                renderConjuntos();
            }
            updateTabTexts();
            switchTab('anuncios');
        };

        // Trocar de tab
        function switchTab(tab) {
            currentTab = tab;
            
            // Atualizar tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });
            
            // Esconder todos os conte√∫dos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Mostrar tab selecionada
            if (tab === 'campanhas') {
                document.getElementById('tabCampanhas').classList.add('active', 'border-blue-500', 'text-blue-600');
                document.getElementById('tabCampanhas').classList.remove('border-transparent', 'text-gray-600');
                document.getElementById('contentCampanhas').classList.remove('hidden');
            } else if (tab === 'conjuntos') {
                document.getElementById('tabConjuntos').classList.add('active', 'border-blue-500', 'text-blue-600');
                document.getElementById('tabConjuntos').classList.remove('border-transparent', 'text-gray-600');
                document.getElementById('contentConjuntos').classList.remove('hidden');
                renderConjuntos();
            } else if (tab === 'anuncios') {
                document.getElementById('tabAnuncios').classList.add('active', 'border-blue-500', 'text-blue-600');
                document.getElementById('tabAnuncios').classList.remove('border-transparent', 'text-gray-600');
                document.getElementById('contentAnuncios').classList.remove('hidden');
                renderAnuncios();
            } else if (tab === 'extrato') {
                document.getElementById('tabExtrato').classList.add('active', 'border-blue-500', 'text-blue-600');
                document.getElementById('tabExtrato').classList.remove('border-transparent', 'text-gray-600');
                document.getElementById('contentExtrato').classList.remove('hidden');
                loadExtrato();
            }
        }

        // Atualizar badges
        function updateBadges() {
            document.getElementById('badgeCampanhas').textContent = hierarchyData.length;
            
            const totalConjuntos = hierarchyData.reduce((sum, c) => sum + c.conjuntos.length, 0);
            const badgeConjuntos = document.getElementById('badgeConjuntos');
            if (totalConjuntos > 0) {
                badgeConjuntos.textContent = totalConjuntos;
                badgeConjuntos.classList.remove('hidden');
            }
            
            const totalAnuncios = hierarchyData.reduce((sum, c) => 
                sum + c.conjuntos.reduce((s, conj) => s + conj.anuncios.length, 0), 0);
            const badgeAnuncios = document.getElementById('badgeAnuncios');
            if (totalAnuncios > 0) {
                badgeAnuncios.textContent = totalAnuncios;
                badgeAnuncios.classList.remove('hidden');
            }
        }

        // Atualizar contador de selecionados
        function updateSelectedCount() {
            const total = selectedCampanhas.size + selectedConjuntos.size + selectedAnuncios.size;
            document.getElementById('selectedCountText').textContent = `${total} selecionado${total !== 1 ? 's' : ''}`;
        }

        // Filtrar convers√µes baseado na sele√ß√£o
        function filterConversions() {
            loadConversions();
            loadStats();
        }

        // Selecionar tudo / Desmarcar tudo
        document.getElementById('btnSelectAll').addEventListener('click', () => {
            if (currentTab === 'campanhas') {
                hierarchyData.forEach(c => selectedCampanhas.add(c.nome));
                renderCampanhas();
            } else if (currentTab === 'conjuntos') {
                hierarchyData.forEach(campanha => {
                    if (selectedCampanhas.has(campanha.nome)) {
                        campanha.conjuntos.forEach(conj => {
                            selectedConjuntos.add(`${campanha.nome}::${conj.nome}`);
                        });
                    }
                });
                renderConjuntos();
            } else if (currentTab === 'anuncios') {
                hierarchyData.forEach(campanha => {
                    campanha.conjuntos.forEach(conj => {
                        const key = `${campanha.nome}::${conj.nome}`;
                        if (selectedConjuntos.has(key)) {
                            conj.anuncios.forEach(anuncio => {
                                selectedAnuncios.add(`${campanha.nome}::${conj.nome}::${anuncio.nome}`);
                            });
                        }
                    });
                });
                renderAnuncios();
            }
            updateSelectedCount();
            filterConversions();
        });

        document.getElementById('btnDeselectAll').addEventListener('click', () => {
            if (currentTab === 'campanhas') {
                selectedCampanhas.clear();
                selectedConjuntos.clear();
                selectedAnuncios.clear();
                renderCampanhas();
            } else if (currentTab === 'conjuntos') {
                selectedConjuntos.clear();
                selectedAnuncios.clear();
                renderConjuntos();
            } else if (currentTab === 'anuncios') {
                selectedAnuncios.clear();
                renderAnuncios();
            }
            updateSelectedCount();
            filterConversions();
        });

        // Fun√ß√£o para carregar extrato de postbacks
        let extratoData = [];
        let extratoSemFiltros = false; // Flag para mostrar todos os postbacks sem filtros
        
        async function loadExtrato() {
            try {
                let url = '/api/extrato';
                const params = [];
                
                // Se a flag extratoSemFiltros estiver ativa, n√£o aplicar filtros
                if (!extratoSemFiltros) {
                    // Filtro por produto (prioridade)
                    if (produtoSelecionado) {
                        params.push(`offerId=${produtoSelecionado.offerId}`);
                    }
                    
                    // Adicionar filtros de data se houver
                    if (selectedDate) {
                        params.push(`date=${selectedDate}`);
                    } else if (selectedStartDate && selectedEndDate) {
                        params.push(`startDate=${selectedStartDate}`, `endDate=${selectedEndDate}`);
                    }
                }
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                extratoData = await response.json();
                console.log('üìã Extrato carregado:', extratoData.length, 'registros');
                renderExtrato();
            } catch (error) {
                console.error('‚ùå Erro ao carregar extrato:', error);
                const table = document.getElementById('extratoTable');
                if (table) {
                    table.innerHTML = `<tr><td colspan="10" class="px-6 py-8 text-center text-red-500">Erro ao carregar extrato: ${error.message}</td></tr>`;
                }
            }
        }

        // Fun√ß√£o para renderizar extrato
        function renderExtrato() {
            const table = document.getElementById('extratoTable');
            const totalElement = document.getElementById('extratoTotal');
            
            if (!table) return;
            
            if (extratoData.length === 0) {
                table.innerHTML = `
                                    <tr>
                                        <td colspan="11" class="px-6 py-8 text-center text-gray-500">
                                            <div class="flex flex-col items-center">
                                                <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                                <p>Nenhum postback encontrado</p>
                                            </div>
                                        </td>
                                    </tr>
                `;
                if (totalElement) totalElement.textContent = '0';
                return;
            }
            
            // Atualizar total e badge
            if (totalElement) totalElement.textContent = extratoData.length;
            const badgeExtrato = document.getElementById('badgeExtrato');
            if (badgeExtrato) {
                badgeExtrato.textContent = extratoData.length;
                badgeExtrato.classList.remove('hidden');
            }
            
            // Renderizar tabela
            table.innerHTML = extratoData.map(item => {
                const tipoClass = {
                    'lead': 'bg-blue-100 text-blue-800',
                    'conversao': 'bg-green-100 text-green-800',
                    'approval': 'bg-green-100 text-green-800',
                    'cancel': 'bg-red-100 text-red-800',
                    'rejection': 'bg-red-100 text-red-800',
                    'trash': 'bg-orange-100 text-orange-800'
                }[item.notification_type] || 'bg-gray-100 text-gray-800';
                
                const subIds = [
                    item.sub_id1 ? `sub1: ${item.sub_id1}` : '',
                    item.sub_id2 ? `sub2: ${item.sub_id2}` : '',
                    item.sub_id3 ? `sub3: ${item.sub_id3}` : '',
                    item.sub_id4 ? `sub4: ${item.sub_id4}` : '',
                    item.sub_id5 ? `sub5: ${item.sub_id5}` : '',
                    item.sub_id6 ? `sub6: ${item.sub_id6}` : ''
                ].filter(Boolean).join(', ') || 'N/A';
                
                const dateTime = item.created_at ? formatTime(item.created_at) : 'N/A';
                const dateOnly = item.date || (item.created_at ? item.created_at.split(' ')[0] : 'N/A');
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${item.id || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            <div>${dateOnly}</div>
                            <div class="text-xs text-gray-500">${dateTime}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${tipoClass}">
                                ${item.notification_type || 'N/A'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">${item.campanha || item.sub_id6 || item.sub_id3 || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${item.conjunto || item.sub_id5 || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${item.anuncio || item.sub_id4 || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${item.lead_id || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${item.offer_id || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${item.status || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-green-600">${item.payout ? formatCurrencyBRL(item.payout) : 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-500" title="${subIds}">
                            <div class="max-w-xs truncate">${subIds}</div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Event listeners para tabs
        document.getElementById('tabCampanhas').addEventListener('click', () => switchTab('campanhas'));
        document.getElementById('tabConjuntos').addEventListener('click', () => switchTab('conjuntos'));
        document.getElementById('tabAnuncios').addEventListener('click', () => switchTab('anuncios'));
        document.getElementById('tabExtrato').addEventListener('click', () => switchTab('extrato'));

        // Atualizar texto das tabs com contagem
        function updateTabTexts() {
            if (selectedCampanhas.size > 0) {
                // Contar conjuntos das campanhas selecionadas
                const totalConjuntos = hierarchyData
                    .filter(c => selectedCampanhas.has(c.nome))
                    .reduce((sum, c) => sum + c.conjuntos.length, 0);
                
                document.getElementById('tabConjuntosText').textContent = `Conjuntos de an√∫ncios para ${selectedCampanhas.size} campanha${selectedCampanhas.size > 1 ? 's' : ''}`;
                document.getElementById('badgeConjuntos').textContent = totalConjuntos;
                document.getElementById('badgeConjuntos').classList.remove('hidden');
            } else {
                document.getElementById('tabConjuntosText').textContent = 'Conjuntos de an√∫ncios';
                const totalConjuntos = hierarchyData.reduce((sum, c) => sum + c.conjuntos.length, 0);
                if (totalConjuntos > 0) {
                    document.getElementById('badgeConjuntos').textContent = totalConjuntos;
                    document.getElementById('badgeConjuntos').classList.remove('hidden');
                } else {
                    document.getElementById('badgeConjuntos').classList.add('hidden');
                }
            }
            if (selectedConjuntos.size > 0) {
                // Contar an√∫ncios dos conjuntos selecionados
                const totalAnuncios = hierarchyData
                    .reduce((sum, campanha) => {
                        return sum + campanha.conjuntos
                            .filter(conj => selectedConjuntos.has(`${campanha.nome}::${conj.nome}`))
                            .reduce((s, conj) => s + conj.anuncios.length, 0);
                    }, 0);
                
                document.getElementById('tabAnunciosText').textContent = `An√∫ncios para ${selectedConjuntos.size} conjunto${selectedConjuntos.size > 1 ? 's' : ''}`;
                document.getElementById('badgeAnuncios').textContent = totalAnuncios;
                document.getElementById('badgeAnuncios').classList.remove('hidden');
            } else {
                document.getElementById('tabAnunciosText').textContent = 'An√∫ncios';
                const totalAnuncios = hierarchyData.reduce((sum, c) => 
                    sum + c.conjuntos.reduce((s, conj) => s + conj.anuncios.length, 0), 0);
                if (totalAnuncios > 0) {
                    document.getElementById('badgeAnuncios').textContent = totalAnuncios;
                    document.getElementById('badgeAnuncios').classList.remove('hidden');
                } else {
                    document.getElementById('badgeAnuncios').classList.add('hidden');
                }
            }
        }

        // ============================================
        // FIM DO GERENCIAMENTO DE HIERARQUIA
        // ============================================

        // Inicializa√ß√£o
        const today = new Date();
        document.getElementById('currentDateDisplay').textContent = formatDate(formatDateISO(today));
        // N√£o carregar hierarquia automaticamente - aguardar sele√ß√£o de data
        // loadHierarchy(); // Removido - s√≥ carregar quando houver data selecionada
        loadDatesWithConversions();
        loadStats();
        loadConversions();
        renderCalendar();
        updateFilterInfo();

        // ============================================
        // GERENCIAMENTO DE PRODUTOS
        // ============================================
        // (produtoSelecionado e produtosData j√° foram declarados acima)

        // Carregar produtos
        async function loadProdutos() {
            try {
                const response = await fetch('/api/produtos');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                produtosData = await response.json();
                renderListaProdutos();
                renderListaProdutosSelecao();
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos:', error);
            }
        }

        // Carregar contas do Facebook
        async function loadContas() {
            try {
                console.log('üîÑ Carregando contas...');
                const response = await fetch('/api/contas');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                contasData = await response.json();
                console.log('‚úÖ Contas carregadas:', contasData);
                renderListaContasSelecao();
            } catch (error) {
                console.error('‚ùå Erro ao carregar contas:', error);
                const lista = document.getElementById('listaContasSelecao');
                if (lista) {
                    lista.innerHTML = `<div class="col-span-full text-center text-red-500 py-8">Erro ao carregar contas: ${error.message}</div>`;
                }
            }
        }

        // Renderizar lista de contas para sele√ß√£o
        function renderListaContasSelecao() {
            const lista = document.getElementById('listaContasSelecao');
            if (!lista) return;

            if (contasData.length === 0) {
                lista.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Nenhuma conta encontrada. Cadastre produtos com "Nome da Conta" para que apare√ßam aqui.</div>';
                return;
            }

            lista.innerHTML = contasData.map(conta => `
                <div class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors" onclick="selecionarConta('${conta.conta.replace(/'/g, "\\'")}')">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900">${conta.conta}</div>
                            <div class="text-sm text-gray-500">Conta do Facebook</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Selecionar conta para filtro
        window.selecionarConta = function(conta) {
            contaSelecionada = conta;
            document.getElementById('modalContas').classList.add('hidden');
            document.getElementById('filtroContaAtivo').classList.remove('hidden');
            document.getElementById('nomeContaFiltro').textContent = conta;
            
            // Recarregar dados com filtro
            loadStats();
            loadConversions();
            loadHierarchy();
            if (currentTab === 'extrato') {
                loadExtrato();
            }
        };

        // Renderizar lista de produtos no cadastro
        function renderListaProdutos() {
            const lista = document.getElementById('listaProdutos');
            if (!lista) return;

            if (produtosData.length === 0) {
                lista.innerHTML = '<div class="text-center text-gray-500 py-4">Nenhum produto cadastrado ainda</div>';
                return;
            }

            lista.innerHTML = produtosData.map(produto => `
                <div class="border border-gray-200 rounded-lg p-4 flex items-center justify-between">
                    <div>
                        <div class="font-semibold text-gray-900">${produto.nome_produto}</div>
                        <div class="text-sm text-gray-600">Offer ID: ${produto.offer_id}</div>
                        <div class="text-sm text-gray-600">Conta: ${produto.nome_conta}</div>
                    </div>
                    <button onclick="deleteProduto(${produto.id})" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors">
                        Excluir
                    </button>
                </div>
            `).join('');
        }

        // Renderizar lista de produtos para sele√ß√£o
        function renderListaProdutosSelecao() {
            const lista = document.getElementById('listaProdutosSelecao');
            if (!lista) return;

            if (produtosData.length === 0) {
                lista.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Nenhum produto cadastrado. Cadastre um produto primeiro.</div>';
                return;
            }

            lista.innerHTML = produtosData.map(produto => `
                <div class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors" onclick="selecionarProduto('${produto.offer_id}', '${produto.nome_produto}', '${produto.nome_conta}')">
                    <div class="font-semibold text-gray-900 mb-2">${produto.nome_produto}</div>
                    <div class="text-sm text-gray-600 mb-1">Offer ID: ${produto.offer_id}</div>
                    <div class="text-sm text-gray-600">Conta: ${produto.nome_conta}</div>
                </div>
            `).join('');
        }

        // Selecionar produto e aplicar filtro
        window.selecionarProduto = function(offerId, nomeProduto, nomeConta) {
            produtoSelecionado = { offerId, nomeProduto, nomeConta };
            document.getElementById('modalProdutos').classList.add('hidden');
            document.getElementById('filtroProdutoAtivo').classList.remove('hidden');
            document.getElementById('nomeProdutoFiltro').textContent = nomeProduto;
            document.getElementById('offerIdFiltro').textContent = offerId;
            
            // Recarregar dados com filtro
            loadStats();
            loadConversions();
            loadHierarchy();
            if (currentTab === 'extrato') {
                loadExtrato();
            }
        };

        // Remover filtro de produto
        document.getElementById('removerFiltroProduto').addEventListener('click', () => {
            produtoSelecionado = null;
            document.getElementById('filtroProdutoAtivo').classList.add('hidden');
            loadStats();
            loadConversions();
            loadHierarchy();
            if (currentTab === 'extrato') {
                loadExtrato();
            }
        });

        // Deletar produto
        window.deleteProduto = async function(id) {
            if (!confirm('Tem certeza que deseja excluir este produto?')) return;
            
            try {
                const response = await fetch(`/api/produtos/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Erro ao deletar produto');
                await loadProdutos();
            } catch (error) {
                console.error('‚ùå Erro ao deletar produto:', error);
                alert('Erro ao deletar produto');
            }
        };

        // ============================================
        // UPLOAD E PROCESSAMENTO DE XLSX (CAMPANHAS FACEBOOK)
        // ============================================
        
        // Event listener para bot√£o de upload
        document.getElementById('btnUploadXLSX').addEventListener('click', () => {
            document.getElementById('modalUploadXLSX').classList.remove('hidden');
            // Limpar resultados anteriores
            document.getElementById('xlsxResults').classList.add('hidden');
            document.getElementById('xlsxError').classList.add('hidden');
            document.getElementById('fileName').textContent = '';
            
            // Garantir que os dados estejam carregados
            if (hierarchyData.length === 0) {
                console.log('üìä Carregando hierarquia antes do upload...');
                loadHierarchy();
            }
        });
        
        document.getElementById('closeUploadXLSX').addEventListener('click', () => {
            document.getElementById('modalUploadXLSX').classList.add('hidden');
        });
        
        // Processar arquivo XLSX
        document.getElementById('fileInputXLSX').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('xlsxResults').classList.add('hidden');
            document.getElementById('xlsxError').classList.add('hidden');
            
            try {
                console.log('üìÑ Processando arquivo XLSX:', file.name);
                
                // Ler arquivo como array buffer
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // Pegar primeira planilha
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Converter para JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                console.log('üìä Dados do XLSX:', jsonData);
                
                if (jsonData.length === 0) {
                    throw new Error('Arquivo vazio ou sem dados');
                }
                
                // Identificar colunas (procurar por "gastos", "spend", "gasto", "amount", etc.)
                const firstRow = jsonData[0];
                const columns = Object.keys(firstRow);
                console.log('üìã Colunas encontradas:', columns);
                
                // Procurar coluna de gastos (case insensitive)
                // Prioridade: "Valor usado (BRL)" ou "Valor usado"
                let gastosColumn = null;
                const gastosKeywords = ['valor usado (brl)', 'valor usado', 'valor usad', 'gastos', 'spend', 'gasto', 'amount', 'valor', 'cost', 'custo', 'despesa'];
                for (const col of columns) {
                    const colLower = col.toLowerCase().trim();
                    // Priorizar "Valor usado (BRL)"
                    if (colLower.includes('valor usado') || colLower === 'valor usado (brl)') {
                        gastosColumn = col;
                        break;
                    }
                }
                
                // Se n√£o encontrou "Valor usado", tentar outras op√ß√µes
                if (!gastosColumn) {
                    for (const col of columns) {
                        const colLower = col.toLowerCase();
                        if (gastosKeywords.some(keyword => colLower.includes(keyword))) {
                            gastosColumn = col;
                            break;
                        }
                    }
                }
                
                if (!gastosColumn) {
                    throw new Error('Coluna de gastos n√£o encontrada. Procure por: "Valor usado (BRL)", gastos, spend, amount, valor, cost');
                }
                
                // Procurar coluna de campanha (case insensitive)
                let campanhaColumn = null;
                const campanhaKeywords = ['campanha', 'campaign', 'nome', 'name', 'campaign name'];
                for (const col of columns) {
                    const colLower = col.toLowerCase();
                    if (campanhaKeywords.some(keyword => colLower.includes(keyword))) {
                        campanhaColumn = col;
                        break;
                    }
                }
                
                if (!campanhaColumn) {
                    throw new Error('Coluna de campanha n√£o encontrada. Procure por: campanha, campaign, nome, name');
                }
                
                // Procurar coluna de data (case insensitive)
                let dataColumn = null;
                const dataKeywords = ['in√≠cio dos relat√≥rios', 'inicio dos relatorios', 'in√≠cio', 'inicio', 'data', 'date', 'dia', 'day', 'start', 'in√≠cio dos', 'inicio dos'];
                for (const col of columns) {
                    const colLower = col.toLowerCase().trim();
                    if (dataKeywords.some(keyword => colLower.includes(keyword) || colLower === keyword)) {
                        dataColumn = col;
                        break;
                    }
                }
                
                if (!dataColumn) {
                    throw new Error('Coluna de data n√£o encontrada. Procure por: "In√≠cio dos relat√≥rios", data, date, dia, day');
                }
                
                console.log('‚úÖ Coluna de gastos:', gastosColumn);
                console.log('‚úÖ Coluna de campanha:', campanhaColumn);
                console.log('‚úÖ Coluna de data:', dataColumn);
                
                // Obter lista de campanhas do app
                const campanhasApp = new Set();
                hierarchyData.forEach(campanha => {
                    campanhasApp.add(campanha.nome);
                });
                console.log('üìä Campanhas no app:', Array.from(campanhasApp));
                
                // Processar dados: agrupar por data e filtrar apenas campanhas que existem no app
                // IMPORTANTE: Substituir valores, n√£o somar
                const gastosPorData = {}; // { "2025-11-21": { "campanha1": 100, "campanha2": 200 }, ... }
                const campanhasEncontradas = [];
                const campanhasProcessadas = new Set(); // Para evitar duplicatas na lista de encontradas
                
                jsonData.forEach(row => {
                    const nomeCampanha = row[campanhaColumn];
                    const gastosValue = row[gastosColumn];
                    const dataValue = row[dataColumn];
                    
                    if (!nomeCampanha) return;
                    
                    // Converter data para formato ISO
                    const dataISO = parseDateToISO(dataValue);
                    if (!dataISO) {
                        console.warn('‚ö†Ô∏è Data inv√°lida para campanha:', nomeCampanha, 'Data:', dataValue);
                        return;
                    }
                    
                    // Verificar se a campanha existe no app
                    if (campanhasApp.has(nomeCampanha)) {
                        // Converter gastos para n√∫mero
                        let gastos = 0;
                        if (typeof gastosValue === 'number') {
                            gastos = gastosValue;
                        } else if (typeof gastosValue === 'string') {
                            // Remover s√≠mbolos e converter
                            gastos = parseFloat(gastosValue.replace(/[^0-9.,-]/g, '').replace(',', '.')) || 0;
                        }
                        
                        // Agrupar por data - SUBSTITUIR, n√£o somar
                        if (!gastosPorData[dataISO]) {
                            gastosPorData[dataISO] = {};
                        }
                        
                        // Se a mesma campanha aparecer m√∫ltiplas vezes na mesma data, usar o √∫ltimo valor
                        // (substituir, n√£o somar)
                        gastosPorData[dataISO][nomeCampanha] = gastos;
                        
                        // Adicionar ou atualizar na lista de encontradas (usar √∫ltimo valor se j√° existir)
                        const key = `${dataISO}::${nomeCampanha}`;
                        const existingIndex = campanhasEncontradas.findIndex(c => c.nome === nomeCampanha && c.data === dataISO);
                        if (existingIndex >= 0) {
                            // Atualizar valor existente (substituir, n√£o somar)
                            campanhasEncontradas[existingIndex].gastos = gastos;
                        } else {
                            // Adicionar nova campanha
                            campanhasEncontradas.push({
                                nome: nomeCampanha,
                                gastos: gastos,
                                data: dataISO
                            });
                        }
                    }
                });
                
                console.log('üìÖ Gastos agrupados por data:', gastosPorData);
                
                // Carregar gastos existentes do localStorage
                const gastosExistentes = loadGastosFromStorage();
                
                // SUBSTITUIR completamente os gastos das datas processadas (n√£o somar)
                Object.keys(gastosPorData).forEach(data => {
                    // Substituir completamente os gastos desta data pelos do XLSX
                    gastosExistentes[data] = { ...gastosPorData[data] };
                    console.log(`üíæ Substituindo gastos para ${data}:`, gastosPorData[data]);
                });
                
                // Salvar no localStorage
                saveGastosToStorage(gastosExistentes);
                
                // Calcular total apenas para exibi√ß√£o no resumo
                let totalGastos = 0;
                campanhasEncontradas.forEach(c => {
                    totalGastos += c.gastos;
                });
                
                console.log('‚úÖ Campanhas encontradas no app:', campanhasEncontradas);
                console.log('üí∞ Total de gastos processados:', totalGastos);
                
                if (campanhasEncontradas.length === 0) {
                    document.getElementById('xlsxError').classList.remove('hidden');
                    document.getElementById('xlsxError').textContent = 'Nenhuma campanha do arquivo foi encontrada no app. Verifique se os nomes das campanhas correspondem.';
                    return;
                }
                
                // Ordenar por gastos (maior para menor)
                campanhasEncontradas.sort((a, b) => b.gastos - a.gastos);
                
                // Agrupar campanhas por data para exibi√ß√£o
                const campanhasPorData = {};
                campanhasEncontradas.forEach(campanha => {
                    const data = campanha.data;
                    if (!campanhasPorData[data]) {
                        campanhasPorData[data] = [];
                    }
                    campanhasPorData[data].push(campanha);
                });
                
                // Renderizar resultados na tabela do modal (agrupados por data)
                const tbody = document.getElementById('xlsxTableBody');
                const datasOrdenadas = Object.keys(campanhasPorData).sort().reverse();
                
                tbody.innerHTML = datasOrdenadas.map(data => {
                    const campanhasDaData = campanhasPorData[data];
                    const totalGastosData = campanhasDaData.reduce((sum, c) => sum + c.gastos, 0);
                    
                    return campanhasDaData.map((campanha, index) => `
                    <tr class="hover:bg-gray-50">
                        ${index === 0 ? `<td rowspan="${campanhasDaData.length}" class="px-4 py-3 text-sm font-semibold text-gray-700 align-top">${formatDate(data)}</td>` : ''}
                        <td class="px-4 py-3 text-sm text-gray-900">${campanha.nome}</td>
                        <td class="px-4 py-3 text-sm font-semibold text-red-600">${formatCurrencyBRLDirect(campanha.gastos)}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">Salvo</span>
                        </td>
                    </tr>
                    `).join('');
                }).join('');
                
                // Atualizar resumo
                document.getElementById('totalCampanhas').textContent = campanhasEncontradas.length;
                document.getElementById('totalGastos').textContent = formatCurrencyBRLDirect(totalGastos);
                
                // Mostrar resultados
                document.getElementById('xlsxResults').classList.remove('hidden');
                
                // Atualizar visualiza√ß√£o das campanhas com os gastos salvos
                console.log('üîÑ Atualizando visualiza√ß√£o das campanhas...');
                // Carregar gastos para todas as datas que foram atualizadas
                if (selectedDate) {
                    loadGastosForDate(selectedDate);
                    renderCampanhas();
                } else if (selectedStartDate) {
                    loadGastosForDate(selectedStartDate);
                    renderCampanhas();
                }
                
                // Atualizar m√©tricas financeiras ap√≥s processar XLSX
                updateFinancialMetrics();
                
            } catch (error) {
                console.error('‚ùå Erro ao processar XLSX:', error);
                document.getElementById('xlsxError').classList.remove('hidden');
                document.getElementById('xlsxError').textContent = `Erro ao processar arquivo: ${error.message}`;
            }
        });
        
        // ============================================
        // FIM UPLOAD XLSX
        // ============================================

        // Event listeners para modais
        document.getElementById('btnCadastroProdutos').addEventListener('click', () => {
            document.getElementById('modalCadastroProdutos').classList.remove('hidden');
            loadProdutos();
        });

        document.getElementById('closeCadastroProdutos').addEventListener('click', () => {
            document.getElementById('modalCadastroProdutos').classList.add('hidden');
        });

        document.getElementById('btnProdutos').addEventListener('click', () => {
            document.getElementById('modalProdutos').classList.remove('hidden');
            loadProdutos();
        });

        document.getElementById('closeProdutos').addEventListener('click', () => {
            document.getElementById('modalProdutos').classList.add('hidden');
        });

        document.getElementById('btnContas').addEventListener('click', () => {
            document.getElementById('modalContas').classList.remove('hidden');
            loadContas();
        });

        document.getElementById('closeContas').addEventListener('click', () => {
            document.getElementById('modalContas').classList.add('hidden');
        });

        // Remover filtro de conta
        document.getElementById('removerFiltroConta').addEventListener('click', () => {
            contaSelecionada = null;
            document.getElementById('filtroContaAtivo').classList.add('hidden');
            loadStats();
            loadConversions();
            loadHierarchy();
            if (currentTab === 'extrato') {
                loadExtrato();
            }
        });

        // Formul√°rio de cadastro
        document.getElementById('formProduto').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nomeProduto = document.getElementById('nomeProduto').value;
            const offerId = document.getElementById('offerIdProduto').value;
            const nomeConta = document.getElementById('nomeContaProduto').value;

            try {
                const response = await fetch('/api/produtos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome_produto: nomeProduto, offer_id: offerId, nome_conta: nomeConta })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao cadastrar produto');
                }

                // Limpar formul√°rio
                document.getElementById('formProduto').reset();
                await loadProdutos();
                alert('Produto cadastrado com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao cadastrar produto:', error);
                alert(error.message || 'Erro ao cadastrar produto');
            }
        });

        // Atualizar a cada 10 segundos
        setInterval(() => {
            loadHierarchy();
            loadDatesWithConversions();
            loadStats();
            loadConversions();
            if (currentTab === 'extrato') {
                loadExtrato();
            }
        }, 10000);

        // Carregar produtos na inicializa√ß√£o
        loadProdutos();
        
        // Event listener para taxa de c√¢mbio
        const taxaCambioInput = document.getElementById('taxaCambio');
        if (taxaCambioInput) {
            // Atualizar display inicial
            const taxaDisplay = document.getElementById('taxaDisplay');
            if (taxaDisplay) {
                taxaDisplay.textContent = TAXA_CAMBIO_USD_BRL.toFixed(2).replace('.', ',');
            }
            
            // Atualizar quando o valor mudar
            taxaCambioInput.addEventListener('change', () => {
                atualizarTaxaCambio();
            });
            
            // Atualizar tamb√©m ao digitar (debounce)
            let timeoutTaxa;
            taxaCambioInput.addEventListener('input', () => {
                clearTimeout(timeoutTaxa);
                timeoutTaxa = setTimeout(() => {
                    atualizarTaxaCambio();
                }, 500);
            });
        }
        
        // Bot√£o "Ver Todos os Postbacks" na aba Extrato
        document.getElementById('btnVerTodosExtrato').addEventListener('click', () => {
            extratoSemFiltros = !extratoSemFiltros;
            const btn = document.getElementById('btnVerTodosExtrato');
            if (extratoSemFiltros) {
                btn.textContent = 'Aplicar Filtros';
                btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                btn.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                btn.textContent = 'Ver Todos os Postbacks';
                btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            }
            loadExtrato();
        });
    </script>
</body>
</html>
